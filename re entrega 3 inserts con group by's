INSERT INTO LOS_HELECHOS.BI_Hecho_Compra (id_tiempo, id_sucursal, id_proveedor, id_material, tipo_material, cantidad, precio_unitario, subtotal)
SELECT 
    t.id_tiempo,
    c.suc_compra,
    c.cuit_proveedor,
    dc.material_comprado,
    CASE 
        WHEN ex.t = 'Tela' THEN 'Tela'
        WHEN ex.t = 'Madera' THEN 'Madera'
        WHEN ex.t = 'Relleno' THEN 'Relleno'
        ELSE 'Otro'
    END ,
    dc.cantidad,
    dc.precio,
    dc.subtotal
FROM LOS_HELECHOS.Compra c
JOIN LOS_HELECHOS.Detalle_Compra dc ON c.nro_compra = dc.nro_compra
JOIN LOS_HELECHOS.BI_Dim_Tiempo t ON t.anio = YEAR(c.fecha) AND t.mes = MONTH(c.fecha)
LEFT JOIN (
    SELECT id_material, 'Tela' AS t FROM LOS_HELECHOS.Tela
    UNION
    SELECT id_material, 'Madera' FROM LOS_HELECHOS.Madera
    UNION
    SELECT id_material, 'Relleno' FROM LOS_HELECHOS.Relleno
    
) ex ON dc.material_comprado = ex.id_material
group by t.id_tiempo,  c.suc_compra,c.cuit_proveedor,dc.material_comprado,dc.cantidad,dc.precio, dc.subtotal,CASE 
                                                                                                                    WHEN ex.t = 'Tela' THEN 'Tela'
                                                                                                                    WHEN ex.t = 'Madera' THEN 'Madera'
                                                                                                                    WHEN ex.t = 'Relleno' THEN 'Relleno'
                                                                                                                    ELSE 'Otro'
                                                                                                                END
order by t.id_tiempo,  c.suc_compra,c.cuit_proveedor,dc.material_comprado,dc.cantidad,dc.precio, dc.subtotal,CASE 
                                                                                                                    WHEN ex.t = 'Tela' THEN 'Tela'
                                                                                                                    WHEN ex.t = 'Madera' THEN 'Madera'
                                                                                                                    WHEN ex.t = 'Relleno' THEN 'Relleno'
                                                                                                                    ELSE 'Otro'
                                                                                                                END



INSERT INTO LOS_HELECHOS.BI_Hecho_Venta (
    id_tiempo, id_sucursal, id_cliente, id_sillon, id_turno,
    cantidad, total_venta
)
SELECT
    t.id_tiempo,
    f.nro_sucursal,
    f.nro_cliente,
    s.codigo_sillon,
    -- Turno seg√∫n hora de la factura
    CASE 
        WHEN DATEPART(HOUR, f.fecha) BETWEEN 8 AND 13 THEN 1
        WHEN DATEPART(HOUR, f.fecha) BETWEEN 14 AND 19 THEN 2
        ELSE 3
    END AS id_turno,
    df.cantidad,
    df.subtotal
FROM LOS_HELECHOS.Factura f
JOIN LOS_HELECHOS.Detalle_Factura df ON f.nro_factura = df.nro_factura
JOIN LOS_HELECHOS.Sillon s ON df.id_sillon = s.codigo_sillon
JOIN LOS_HELECHOS.BI_Dim_Tiempo t ON t.anio = YEAR(f.fecha) AND t.mes = MONTH(f.fecha)

group by t.id_tiempo,
    f.nro_sucursal,
    f.nro_cliente,
    s.codigo_sillon,
    CASE 
        WHEN DATEPART(HOUR, f.fecha) BETWEEN 8 AND 13 THEN 1
        WHEN DATEPART(HOUR, f.fecha) BETWEEN 14 AND 19 THEN 2
        ELSE 3
    END,
    df.cantidad,
    df.subtotal

order by t.id_tiempo,
    f.nro_sucursal,
    f.nro_cliente,
    s.codigo_sillon,
    id_turno,
    df.cantidad,
    df.subtotal


INSERT INTO LOS_HELECHOS.BI_Hecho_Pedido (
    id_pedido, id_tiempo, id_sucursal, id_cliente, estado_pedido,
    cantidad_items, total_pedido, id_turno
)
SELECT
    p.nro_pedido,
    t.id_tiempo,
    p.nro_sucursal,
    p.nro_cliente,
    p.estado,
    ISNULL(SUM(dp.cantidad), 0),
    p.total,
    CASE 
        WHEN DATEPART(HOUR, p.fecha) BETWEEN 8 AND 13 THEN 1
        WHEN DATEPART(HOUR, p.fecha) BETWEEN 14 AND 19 THEN 2
        ELSE 3
    END AS id_turno
FROM LOS_HELECHOS.Pedido p
LEFT JOIN LOS_HELECHOS.Detalle_Pedido dp ON p.nro_pedido = dp.nro_pedido
JOIN LOS_HELECHOS.BI_Dim_Tiempo t 
    ON t.anio = YEAR(p.fecha) AND t.mes = MONTH(p.fecha)
GROUP BY 
    p.nro_pedido, t.id_tiempo, p.nro_sucursal, p.nro_cliente, 
    p.estado, p.total, p.fecha

order by p.nro_pedido, t.id_tiempo, p.nro_sucursal, p.nro_cliente, 
    p.estado, p.total, p.fecha


