INSERT INTO LOS_HELECHOS.BI_Hecho_Compra (id_tiempo, id_sucursal, id_proveedor, id_material, tipo_material, cantidad, precio_unitario, subtotal)
SELECT 
    t.id_tiempo,
    c.suc_compra,
    c.cuit_proveedor,
    dc.material_comprado,
    CASE 
        WHEN ex.t = 'Tela' THEN 'Tela'
        WHEN ex.t = 'Madera' THEN 'Madera'
        WHEN ex.t = 'Relleno' THEN 'Relleno'
        ELSE 'Otro'
    END ,
    dc.cantidad,
    dc.precio,
    dc.subtotal
FROM LOS_HELECHOS.Compra c
JOIN LOS_HELECHOS.Detalle_Compra dc ON c.nro_compra = dc.nro_compra
JOIN LOS_HELECHOS.BI_Dim_Tiempo t ON t.anio = YEAR(c.fecha) AND t.mes = MONTH(c.fecha)
LEFT JOIN (
    SELECT id_material, 'Tela' AS t FROM LOS_HELECHOS.Tela
    UNION
    SELECT id_material, 'Madera' FROM LOS_HELECHOS.Madera
    UNION
    SELECT id_material, 'Relleno' FROM LOS_HELECHOS.Relleno
    
) ex ON dc.material_comprado = ex.id_material
group by t.id_tiempo,  c.suc_compra,c.cuit_proveedor,dc.material_comprado,dc.cantidad,dc.precio, dc.subtotal,CASE 
                                                                                                                    WHEN ex.t = 'Tela' THEN 'Tela'
                                                                                                                    WHEN ex.t = 'Madera' THEN 'Madera'
                                                                                                                    WHEN ex.t = 'Relleno' THEN 'Relleno'
                                                                                                                    ELSE 'Otro'
                                                                                                                END
order by t.id_tiempo,  c.suc_compra,c.cuit_proveedor,dc.material_comprado,dc.cantidad,dc.precio, dc.subtotal,CASE 
                                                                                                                    WHEN ex.t = 'Tela' THEN 'Tela'
                                                                                                                    WHEN ex.t = 'Madera' THEN 'Madera'
                                                                                                                    WHEN ex.t = 'Relleno' THEN 'Relleno'
                                                                                                                    ELSE 'Otro'
                                                                                                                END
